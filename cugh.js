function initializeVirtualPiano(){let e=null,t=null,n=null;const o={},a={},i=document.querySelectorAll(".piano-keys .key"),s=document.querySelector("#volume-slider"),c=(document.getElementById("keys-toggle"),document.getElementById("sustain-btn")),r=document.getElementById("sound-btn"),l=document.getElementById("rec-btn"),d=document.getElementById("play-btn"),u=document.getElementById("play-song-btn"),g=document.getElementById("stop-btn"),f=document.getElementById("learn-btn"),y=document.querySelector(".display"),m=document.getElementById("piano-wrapper"),b=document.getElementById("scale-slider"),p=document.getElementById("scale-value"),v=document.getElementById("now-playing-label"),h=document.querySelectorAll(".song-dropdown-content a");let k=[],E="fur-elise",w=!1,$="synth",L=!1,T=[],C=0,S=[],A=!1,x=!1,q=0,N=null,B={},O=null;function G(){if(!e)try{e=new(window.AudioContext||window.webkitAudioContext),n=e.createConvolver(),async function(){const t=2.5,n=2,o=e.sampleRate,a=o*t,i=e.createBuffer(2,a,o),s=i.getChannelData(0),c=i.getChannelData(1);for(let e=0;e<a;e++){const t=(a-e)/a,o=(2*Math.random()-1)*Math.pow(t,n);s[e]=o*(1-e/a*.3),c[e]=o*(1-e/a*.3)}return i}().then((o=>{n.buffer=o,t=e.createGain(),n.connect(t),t.connect(e.destination),t.gain.value=s.value||.9})).catch((n=>{console.error("Failed to create reverb:",n),t=e.createGain(),t.connect(e.destination),t.gain.value=s.value||.9})),"suspended"===e.state&&e.resume()}catch(e){console.error("Error initializing audio:",e)}}function D(){return e||G(),e&&"suspended"===e.state&&e.resume(),!t&&e&&(t=e.createGain(),t.connect(e.destination),t.gain.value=s.value||.9),e}const I={C2:65.41,"C#2":69.3,D2:73.42,"D#2":77.78,E2:82.41,F2:87.31,"F#2":92.5,G2:98,"G#2":103.83,A2:110,"A#2":116.54,B2:123.47,C3:130.81,"C#3":138.59,D3:146.83,"D#3":155.56,E3:164.81,F3:174.61,"F#3":185,G3:196,"G#3":207.65,A3:220,"A#3":233.08,B3:246.94,C4:261.63,"C#4":277.18,D4:293.66,"D#4":311.13,E4:329.63,F4:349.23,"F#4":369.99,G4:392,"G#4":415.3,A4:440,"A#4":466.16,B4:493.88,C5:523.3,"C#5":554.4,D5:587.3,"D#5":622.3,E5:659.3,F5:698.5,"F#5":740,G5:784,"G#5":830.6,A5:880,"A#5":932.3,B5:987.8,C6:1047};function F(){const e=D();if(!e)return null;const t=.03*e.sampleRate,n=e.createBuffer(1,t,e.sampleRate),o=n.getChannelData(0);for(let e=0;e<t;e++){const n=e/t,a=n<.1?n/.1:Math.pow(1-(n-.1)/.9,2);o[e]=(2*Math.random()-1)*a*.5}return n}function V(e,n=!1,i=.8){G();const s=document.querySelector(`[data-key="${e}"]`);if(!s)return void console.warn(`Cannot find key element for key: ${e}`);const c=s.dataset.note;y.textContent=c,(o[e]?.length||a[e]?.length)&&R(e,n),n?s.classList.add("playing"):s.classList.add("active");const r=function(e,n=.8){const o=D();if(!o)return{start:function(){},stop:function(){}};const a=[];let i=!1;const s=o.createGain();switch(s.gain.value=1*n,t?s.connect(t):s.connect(o.destination),$){case"organ":const i=[1,.7,.5,.3,.2,.1,.05];[1,2,3,4,5,6,8].forEach(((t,c)=>{const r=o.createOscillator();r.type=c%2==0?"sine":"triangle",r.frequency.value=e*t;const l=o.createGain();l.gain.value=0,r.connect(l),l.connect(s),r.start();const d=o.currentTime;l.gain.setValueAtTime(0,d),l.gain.linearRampToValueAtTime(i[c]*n,d+.1),a.push({oscillator:r,gainNode:l})}));break;case"synth":const c=o.createOscillator();c.type="sawtooth",c.frequency.value=e,[-10,10,-5,5].forEach((t=>{const i=o.createOscillator();i.type="sawtooth",i.frequency.value=e,i.detune.value=t;const c=o.createGain();c.gain.value=0,i.connect(c),c.connect(s),i.start();const r=o.currentTime;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(.15*n,r+.05),a.push({oscillator:i,gainNode:c})}));const r=o.createGain();r.gain.value=0,c.connect(r),r.connect(s),c.start();const l=o.currentTime;r.gain.setValueAtTime(0,l),r.gain.linearRampToValueAtTime(.5*n,l+.05),a.push({oscillator:c,gainNode:r});const d=o.createBiquadFilter();d.type="lowpass",d.frequency.value=1500,d.Q.value=2,s.disconnect(),s.connect(d),t?d.connect(t):d.connect(o.destination),d.frequency.setValueAtTime(1500,l),d.frequency.linearRampToValueAtTime(500,l+2);break;default:[{ratio:1,type:"sine",gain:.7},{ratio:2,type:"sine",gain:.4},{ratio:3,type:"sine",gain:.2},{ratio:4,type:"sine",gain:.1},{ratio:5,type:"sine",gain:.05},{ratio:6,type:"sine",gain:.025}].forEach((t=>{const i=o.createOscillator();i.type=t.type,i.frequency.value=e*t.ratio;const c=o.createGain();c.gain.value=0,i.connect(c),c.connect(s),i.start();const r=o.currentTime;c.gain.setValueAtTime(0,r),c.gain.linearRampToValueAtTime(t.gain*n,r+.01),c.gain.setTargetAtTime(.6*t.gain*n,r+.01,.1),a.push({oscillator:i,gainNode:c})}));try{const t=F();if(t){const a=o.createBufferSource();a.buffer=t;const i=o.createGain();i.gain.value=.15*n;const c=o.createBiquadFilter();c.type="bandpass",c.frequency.value=2*e,c.Q.value=1,a.connect(c),c.connect(i),i.connect(s),a.start(),a.stop(o.currentTime+.03)}}catch(e){console.error("Error creating noise:",e)}try{const t=o.createBiquadFilter();t.type="bandpass",t.frequency.value=e,t.Q.value=20;const a=o.createGain();a.gain.value=.05*n;const i=o.createBufferSource(),c=F();c&&(i.buffer=c,i.connect(t),t.connect(a),a.connect(s),i.start(),i.stop(o.currentTime+.1))}catch(e){}}return{start:function(){},stop:function(e=0){if(!i){i=!0;try{const t=o.currentTime;e<=0?(s.gain.setValueAtTime(0,t),setTimeout((()=>{try{s.disconnect()}catch(e){}}),1),a.forEach((e=>{try{e.oscillator&&(e.oscillator.stop(t),e.oscillator.disconnect()),e.gainNode&&e.gainNode.disconnect()}catch(e){}}))):(s.gain.setValueAtTime(s.gain.value,t),s.gain.linearRampToValueAtTime(0,t+e),setTimeout((()=>{a.forEach((e=>{try{e.oscillator&&(e.oscillator.stop(),e.oscillator.disconnect()),e.gainNode&&e.gainNode.disconnect()}catch(e){}}));try{s.disconnect()}catch(e){}}),1e3*e+10)),a.length=0}catch(e){console.error("Error stopping sound:",e);try{s.disconnect(),a.forEach((e=>{e.oscillator&&e.oscillator.disconnect(),e.gainNode&&e.gainNode.disconnect()})),a.length=0}catch(e){}}}}}}(I[c],i);if(n)a[e]||(a[e]=[]),a[e]=[r];else if(o[e]||(o[e]=[]),o[e]=[r],L){const t=Date.now()-C;T.push({key:e,startTime:t,velocity:i})}}function R(e,t=!1){const n=document.querySelector(`[data-key="${e}"]`);if(!n)return;t?n.classList.remove("playing"):n.classList.remove("active");const i=t?a:o;if(i[e]?.length){const n=w?.2:0;try{if(i[e].forEach((e=>{e&&"function"==typeof e.stop&&e.stop(n)})),delete i[e],!t&&L){const t=Date.now()-C;for(let n=T.length-1;n>=0;n--)if(T[n].key===e&&!T[n].endTime){T[n].endTime=t;break}}}catch(t){console.error("Error in releaseNote:",t),delete i[e]}}}function P(){console.log("ðŸš¨ EMERGENCY STOP TRIGGERED ðŸš¨");const e=w;t&&(t.gain.value=0),document.querySelectorAll(".piano-keys .key.active, .piano-keys .key.playing").forEach((e=>{e.classList.remove("active"),e.classList.remove("playing")})),S.forEach((e=>clearTimeout(e))),S=[],A=!1,u.classList.remove("active","breathing-green"),u.textContent="Play Song â–¼",d.classList.remove("active","breathing-green"),d.disabled=!1,w=e,c.classList.toggle("active",w),c.textContent=w?"Sustain ON":"Sustain",v.classList.remove("visible"),G()}function j(){if(document.querySelectorAll(".piano-keys .key.active, .piano-keys .key.playing").forEach((e=>{e.classList.remove("active"),e.classList.remove("playing")})),S.forEach((e=>clearTimeout(e))),S=[],A=!1,u.classList.remove("active","breathing-green"),u.textContent="Play Song â–¼",d.classList.remove("active","breathing-green"),d.disabled=!1,v.classList.remove("visible"),[o,a].forEach((e=>{Object.keys(e).forEach((t=>{const n=e[t];n&&n.forEach((e=>{e&&"function"==typeof e.stop&&e.stop(0)})),delete e[t]}))})),t){const e=t.gain.value;t.gain.value=0,setTimeout((()=>{t&&(t.gain.value=e)}),50)}x&&U()}function M(){if(!E||!songs[E])return y.textContent="Select a song first",setTimeout((()=>{y.textContent="C4"}),2e3),!1;q=0;let e=[...songs[E]];return N=ee(e,E),console.log("Learn mode initialized with transposed melody for:",E),console.log("First 5 notes:",N.slice(0,5).map((e=>e.note))),z(),B={},!0}function z(){document.querySelectorAll(".key-indicator").forEach((e=>{e.remove()}))}function U(){z(),B={},q=0,N=null,O&&(clearTimeout(O),O=null)}function Q(){if(z(),q>=N.length)return y.textContent="Song complete!",y.style.backgroundColor="#22AA22",setTimeout((()=>{y.style.backgroundColor="#1E1E1E",y.textContent="C4"}),2e3),void J();for(;q<N.length&&("rest"===N[q].note||"pause"===N[q].note);)q++;if(q>=N.length)return y.textContent="Song complete!",y.style.backgroundColor="#22AA22",setTimeout((()=>{y.style.backgroundColor="#1E1E1E",y.textContent="C4"}),2e3),void J();const e=N[q],t=e.key;if(!t)return console.warn(`Missing key for note: ${e.note} at step ${q}`),q++,void Q();const n=document.querySelector(`.piano-keys .key[data-key="${t}"]`);if(!n)return console.warn(`Cannot find key element for key: ${t} (note: ${e.note})`),q++,void Q();y.textContent=`Play: ${e.note.toUpperCase()}`;let o=n.querySelector(".key-indicator");o||(o=document.createElement("div"),o.className="key-indicator",n.appendChild(o)),o.classList.add("next-key-indicator")}function Y(e){let t=e.querySelector(".key-indicator");t&&(t.classList.remove("next-key-indicator"),t.classList.add("correct-key-indicator"),setTimeout((()=>{t&&t.parentNode&&t.remove()}),300))}function J(){x=!x,f.classList.toggle("active",x),x?(j(),M()?(f.textContent="Exit Learn",Q(),u.disabled=!0,d.disabled=!0,l.disabled=!0):(x=!1,f.classList.remove("active"))):(f.textContent="Learn",U(),y.textContent="C4",u.disabled=!1,d.disabled=!1,l.disabled=!1)}function W(){w=!w,c.classList.toggle("active",w),c.textContent=w?"Effect ON":"Effect Off",w||(Object.keys(o).forEach((e=>{if(o[e]?.length){const t=document.querySelector(`[data-key="${e}"]`);t&&!t.classList.contains("active")&&R(e,!1)}})),Object.keys(a).forEach((e=>{if(a[e]?.length){const t=document.querySelector(`[data-key="${e}"]`);t&&!t.classList.contains("playing")&&R(e,!0)}})))}function H(){const e=["piano","synth","organ"],t=e.indexOf($);$=e[(t+1)%e.length],r.textContent=$.charAt(0).toUpperCase()+$.slice(1)}function K(){L=!L,L?(T=[],C=Date.now(),l.classList.add("active","breathing-red")):l.classList.remove("active","breathing-red")}function X(){if(0===T.length)return d.classList.add("active"),void setTimeout((()=>{d.classList.remove("active")}),300);j(),d.classList.add("active","breathing-green"),d.disabled=!0;const e=[...T].sort(((e,t)=>e.startTime-t.startTime));e.forEach((e=>{const t=setTimeout((()=>{V(e.key,!1,e.velocity||.8)}),e.startTime);if(S.push(t),e.endTime){const t=setTimeout((()=>{R(e.key)}),e.endTime);S.push(t)}else{const t=e.startTime+500,n=setTimeout((()=>{R(e.key)}),t);S.push(n)}}));const t=e.reduce(((e,t)=>{const n=t.endTime||t.startTime+500;return n>e?n:e}),0),n=setTimeout((()=>{d.classList.remove("active","breathing-green"),d.disabled=!1}),t+100);S.push(n)}const Z={c2:"z","c#2":"q",db2:"q",d2:"x","d#2":"2",eb2:"2",e2:"c",f2:"v","f#2":"3",gb2:"3",g2:"b","g#2":"4",ab2:"4",a2:"n","a#2":"5",bb2:"5",b2:"m",c3:",","c#3":"6",db3:"6",d3:".","d#3":"7",eb3:"7",e3:"/",f3:"]","f#3":"8",gb3:"8",g3:"a","g#3":"9",ab3:"9",a3:"s","a#3":"0",bb3:"0",b3:"d",c4:"f","c#4":"-",db4:"-",d4:"g","d#4":"=",eb4:"=",e4:"h",f4:"j","f#4":"w",gb4:"w",g4:"k","g#4":"e",ab4:"e",a4:"l","a#4":"r",bb4:"r",b4:";",c5:"'","c#5":"t",db5:"t",d5:"Enter","d#5":"y",eb5:"y",e5:"i",f5:"o","f#5":"u",gb5:"u",g5:"p",c:",",d:".",e:"/",f:"]",g:"a",a:"s",b:"d","c#":"6",db:"6","d#":"7",eb:"7","f#":"8",gb:"8","g#":"9",ab:"9","a#":"0",bb:"0","c sharp":"6","d sharp":"7","e sharp":"]","f sharp":"8","g sharp":"9","a sharp":"0","b sharp":",","c flat":"d","d flat":"6","e flat":"7","f flat":"/","g flat":"8","a flat":"9","b flat":"0",pause:null,rest:null};function _(e){m.style.transform=`scale(${e})`,m.style.transformOrigin="center top";Math.max(200*e,200);const t=100*(e-1);document.querySelector(".piano-container").style.marginBottom=`${Math.max(t,0)}px`;const n=Math.round(100*e);p.textContent=`${n}%`,m.offsetHeight}function ee(e,t){if(!e||!Array.isArray(e))return e;console.log(`Starting transposition for song: ${t} with ${e.length} notes`);const n=JSON.parse(JSON.stringify(e)),o={a0:"a2","a#0":"a#2",bb0:"bb2",b0:"b2",c1:"c3","c#1":"c#3",db1:"db3",d1:"d3","d#1":"d#3",eb1:"eb3",e1:"e3",f1:"f3","f#1":"f#3",gb1:"gb3",g1:"g3","g#1":"g#3",ab1:"ab3",a1:"a3","a#1":"a#3",bb1:"bb3",b1:"b3",c:"c3",d:"d3",e:"e3",f:"f3",g:"g3",a:"a3",b:"b3","c#":"c#3","d#":"d#3","e#":"f3","f#":"f#3","g#":"g#3","a#":"a#3",bb:"bb3"},a={c2:"z","c#2":"q",db2:"q",d2:"x","d#2":"2",eb2:"2",e2:"c",f2:"v","f#2":"3",gb2:"3",g2:"b","g#2":"4",ab2:"4",a2:"n","a#2":"5",bb2:"5",b2:"m",c3:",","c#3":"6",db3:"6",d3:".","d#3":"7",eb3:"7",e3:"/",f3:"]","f#3":"8",gb3:"8",g3:"a","g#3":"9",ab3:"9",a3:"s","a#3":"0",bb3:"0",b3:"d",c4:"f","c#4":"-",db4:"-",d4:"g","d#4":"=",eb4:"=",e4:"h",f4:"j","f#4":"w",gb4:"w",g4:"k","g#4":"e",ab4:"e",a4:"l","a#4":"r",bb4:"r",b4:";",c5:"'","c#5":"t",db5:"t",d5:"Enter","d#5":"y",eb5:"y",e5:"i",f5:"o","f#5":"u",gb5:"u",g5:"p"},i={"fur-elise":1,greensleeves:1,gymnopedie:1,"happy-birthday":0,lacrimosa:0,minuet:0,"ode-to-joy":1,"twinkle-twinkle":0,nocturne:1,"amazing-grace":0,moonlight:1}[t]||0;let s=0,c=0;function r(e){const t=e.toLowerCase().trim();return a[t]||Z[t]}n.forEach(((e,t)=>{if(!e||!e.note||"pause"===e.note||"rest"===e.note)return;let n=e.note.toLowerCase().trim(),l=n;if(o[n])l=o[n],s++,console.log(`[1] Mapped out-of-range note: ${n} -> ${l}`);else if(1===n.length||2===n.length&&(n.includes("#")||n.includes("b")))l=n+"3",s++,console.log(`[2] Added octave to note: ${n} -> ${l}`);else if(n.match(/[a-g][#b]?[01]$/)){l=n.replace(/[0-9]/g,"")+(parseInt(n.match(/[0-9]+/)[0])+2),s++,console.log(`[3] Raised low octave note: ${n} -> ${l}`)}if(i>0&&l.match(/[a-g][#b]?[0-9]$/)){const e=l.replace(/[0-9]/g,""),t=parseInt(l.match(/[0-9]+/)[0])+i;if(t<=5){const n=e+t;console.log(`[4] Applied song transposition: ${l} -> ${n}`),l=n,s++}}if(l.match(/[0-9]$/)||(l+="3",s++,console.log(`[5] Added missing octave in final check: ${n} -> ${l}`)),!function(e){const t=e.replace(/[0-9]/g,"").toLowerCase();if(t===e)return!1;const n=parseInt(e.match(/[0-9]+/)[0]);return!(n<2||n>5||5===n&&["a","a#","bb","b","h"].includes(t))}(l)||!r(l)){const e=l.replace(/[0-9]/g,"").toLowerCase();let o=!1;for(let t=3;t<=4;t++){const a=e+t;if(r(a)){l=a,s++,o=!0,console.log(`[6] Fixed out-of-range note: ${n} -> ${l}`);break}}if(!o){for(const[t,i]of Object.entries(a))if(t.startsWith(e.charAt(0))){l=t,s++,o=!0,console.log(`[7] Last resort mapping: ${n} -> ${l}`);break}o||(c++,console.warn(`Could not fix note ${n} at index ${t}, no valid mapping found!`))}}const d=r(l);l===n&&e.key&&"undefined"!==e.key||(e.note=l,d&&(e.key=d,console.log(`[8] Assigned key mapping: ${l} -> ${d}`)))})),console.log(`Song ${t}: Fixed ${s} notes, ${c} notes still out of range`);let l=!0,d=[];return n.forEach(((e,t)=>{if(!e||!e.note||"pause"===e.note||"rest"===e.note)return;const n=e.note.toLowerCase().trim(),o=r(n);o?e.key&&"undefined"!==e.key||(e.key=o):(l=!1,d.push({index:t,note:n}))})),l?console.log(`Song ${t} successfully transposed! All notes are now mappable.`):(console.warn(`Song ${t} still has ${d.length} unmappable notes after transposition!`),console.warn("Unmappable notes:",d)),n}function te(t){if(!t)return console.error("No song name provided"),void alert("Error: No song name provided");if(A)return void j();let n;if(G(),e&&"suspended"===e.state&&e.resume(),!window.songs)return console.error("Songs object not loaded"),void alert("Error: Songs not loaded. Try refreshing the page.");if(!window.songs[t])return console.error("Song not found:",t),console.error("Available songs:",Object.keys(window.songs)),void alert(`Song not found: "${t}". Available songs: ${Object.keys(window.songs).join(", ")}`);n=window.songs[t],console.log("Melody found:",n.length,"notes"),console.log("First 5 notes of original melody:",n.slice(0,5)),n=ee(n,t),console.log("Melody transposed. First 5 notes of transposed melody:",n.slice(0,5).map((e=>e.note))),A=!0,E=t,u.classList.add("active","breathing-green"),u.textContent="Playing â™ª";const o=document.querySelector(`a[data-song="${t}"]`);if(o)v.textContent=`Now Playing: ${o.textContent}`,v.classList.add("visible");else{const e=t.replace(/-/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));v.textContent=`Now Playing: ${e}`,v.classList.add("visible")}let a=0,i=0,s=0;const c={};n.forEach(((e,t)=>{if(!e||!e.note)return console.warn(`Invalid note at index ${t}:`,e),void s++;if("pause"===e.note||"rest"===e.note)return void(a+=e.duration||250);const n=e.note.toLowerCase().trim();let o=e.key;if(o&&"undefined"!==o||(o=Z[n]),!o&&(o=function(e){if(c[e])return c[e];let t=null;const n=e.match(/([a-g][#b]?)([0-9])?/);if(!n)return null;const o=n[1],a=n[2]?parseInt(n[2]):3;for(let n=3;n<=4;n++){if(n===a)continue;const i=o+n;if(Z[i]){t=Z[i],console.log(`ðŸš¨ Emergency note substitution (Strategy 1): ${e} -> ${i} (key: ${t})`);break}}if(!t){const n={"c#":"db","d#":"eb","f#":"gb","g#":"ab","a#":"bb"},i={db:"c#",eb:"d#",gb:"f#",ab:"g#",bb:"a#"};let s=null;if(n[o]?s=n[o]:i[o]&&(s=i[o]),s){const n=s+a;Z[n]&&(t=Z[n],console.log(`ðŸš¨ Emergency note substitution (Strategy 2): ${e} -> ${n} (key: ${t})`))}}if(!t){const n=o.charAt(0);for(const[o,a]of Object.entries(Z))if(o.startsWith(n)&&o.match(/[2-5]$/)){t=a,console.log(`ðŸš¨ðŸš¨ Last resort note substitution (Strategy 3): ${e} -> ${o} (key: ${t})`);break}}return t||(t=Z.c4,console.log(`ðŸš¨ðŸš¨ðŸš¨ Absolute final resort (Strategy 4): ${e} -> c4 (key: ${t})`)),c[e]=t,t}(n),!o))return s++,console.warn(`Could not play note: "${e.note}" (normalized: "${n}") at index ${t} - NO VALID KEY MAPPING FOUND`),void(a+=e.duration||250);const r=setTimeout((()=>{V(o,!0,e.velocity||.8)}),a);S.push(r);const l=e.duration-(e.gap||10),d=setTimeout((()=>{R(o,!0)}),a+l);S.push(d),a+=e.duration||250,i++}));const r=setTimeout((()=>{A=!1,u.classList.remove("active","breathing-green"),u.textContent="Play Song â–¼",console.log(`Song ${t} finished: ${i} notes played, ${s} notes skipped`)}),a+200);S.push(r)}i.forEach((e=>{const t=e.dataset.key;k.push(t),e.addEventListener("mousedown",(function(){if(G(),x){const n=N[q];n&&n.key?t===n.key&&(V(t),Y(e),O=setTimeout((()=>{q++,Q()}),300)):V(t)}else V(t)})),e.addEventListener("mouseup",(function(){R(t)})),e.addEventListener("mouseleave",(function(){R(t)})),e.addEventListener("touchstart",(function(n){if(n.preventDefault(),G(),x){const n=N[q];n&&n.key?t===n.key&&(V(t),Y(e),O=setTimeout((()=>{q++,Q()}),300)):V(t)}else V(t)})),e.addEventListener("touchend",(function(){R(t)}))})),document.body.addEventListener("click",G,{once:!0}),document.addEventListener("keydown",(function(e){if(!e.repeat)if(x&&k.includes(e.key)){const t=N[q];if(t&&t.key){if(e.key!==t.key)return void 0;{const t=document.querySelector(`[data-key="${e.key}"]`);V(e.key),Y(t),O=setTimeout((()=>{q++,Q()}),300)}}else V(e.key)}else k.includes(e.key)?V(e.key):"Escape"===e.key?P():" "===e.key&&(P(),e.preventDefault())})),document.addEventListener("keyup",(function(e){k.includes(e.key)&&R(e.key)})),s.addEventListener("input",(function(e){t&&(t.gain.value=e.target.value)})),c.addEventListener("click",W),r.addEventListener("click",H),l.addEventListener("click",K),d.addEventListener("click",X),u.addEventListener("click",(function(){te(E)})),g.addEventListener("click",j),g.addEventListener("dblclick",(function(){P()})),b.addEventListener("input",(function(){_(this.value)})),_(b.value),setTimeout((()=>{_(b.value),b.addEventListener("input",(function(){_(this.value)}))}),100),setTimeout((()=>{window.songs?(console.log("Songs loaded successfully on page load:",Object.keys(window.songs)),console.log("First song (fur-elise) available:",window.songs["fur-elise"]?"YES":"NO")):console.error("Songs not loaded correctly on page load")}),1500),h.forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const t=this.getAttribute("data-song");return E=t,y.textContent=`Selected: ${this.textContent}`,setTimeout((()=>{y.textContent="C4"}),1500),x?(U(),M()&&Q()):te(t),!1}))})),f.addEventListener("click",J),window.playNote=V,window.releaseNote=R,window.toggleSustain=W,window.toggleSound=H,window.toggleRecording=K,window.playRecording=X,window.playSong=te,window.stopAllSounds=j,window.scalePiano=_}window.addEventListener("load",(function(){initializeVirtualPiano()})),initializeVirtualPiano();